<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="s3-file-saver">
    <template>
        <style>
            p {
                display: block;
                color: #aaaaaa;
            }
        </style>
        <iron-ajax id="putUrlGetter"
                   url="{{putUrlServiceUrl}}"
                   method="POST"
                   last-response={{putInfo}}
                   content-type="application/json"
                   handle-as="json"
                   on-response="_putUrlReceived"></iron-ajax>
        <iron-ajax id="fileSaver"
                   url="{{putInfo.signedPutUrl}}"
                   method="PUT"
                   content-type="{{contentType}}"
                   body="{{fileData}}"
                   handle-as="text"
                   on-response="_fileSaved"></iron-ajax>

        <p>{{idToken}}</p>
        <p>{{filePath}}</p>
        <p>{{contentType}}</p>
        <p>{{putUrlServiceUrl}}</p>
        <p>{{fileData}}</p>
        <p>{{putInfo.signedPutUrl}}</p>
        <p>{{putInfo.getUrl}}</p>
    </template>
</dom-module>

<script>
    Polymer({
        is: 's3-file-saver',

        properties: {
            filePath: String,
            contentType: {
                type: String,
                default: 'text/html'
            },
            idToken: String,
            putUrlServiceUrl: String,
            fileData: {
                type: String,
                observer: '_fileDataChanged'
            }
        },

        _fileDataChanged: function (fileContents) {
            console.log("_fileDataChanged");

            // Initialize the Amazon Cognito credentials provider
            AWS.config.region = 'eu-west-1'; // Region
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: 'eu-west-1:c46e1da2-72cf-4965-92b8-ebe270684050',
                Logins: { // optional tokens, used for authenticated login
                    'accounts.google.com': this.idToken
                }
            });

            var s3bucket = new AWS.S3({ params: {Bucket: 'ashridgetech.cmstest'} });
            s3bucket.putObject({
                Key: this.filePath,
                ContentType: this.contentType,
                ACL: 'public-read',
                Body: fileContents
            }, function(error, data) {
                if (error) {
                    console.log('Error', error); // an error occurred
                } else {
                    console.log('Success', data); // request succeeded
                }
            });

        },

        _putUrlReceived: function(e) {
            console.log('Put url received');
            this.$.fileSaver.body;
            this.$.fileSaver.generateRequest();
        },

        _fileSaved: function(e) {
            console.log('File saved');
        }

    });
</script>
