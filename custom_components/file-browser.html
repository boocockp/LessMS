<link rel="import" href="../bower_components/polymer/polymer.html">

<link href="../bower_components/font-awesome/css/font-awesome.css" rel="stylesheet">
<link href="../bower_components/ag-grid/dist/ag-grid.css" rel="stylesheet">
<link href="../bower_components/ag-grid/dist/theme-fresh.css" rel="stylesheet">
<style>

    .ag-file-browser .ag-root {
        border: 1px solid grey;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    .ag-file-browser .ag-cell {
        padding-left: 8px;
        padding-right: 8px;
    }

    .ag-file-browser .ag-header-container {
        background: -webkit-linear-gradient(white, lightgrey); /* For Safari 5.1 to 6.0 */
        background: -o-linear-gradient(white, lightgrey); /* For Opera 11.1 to 12.0 */
        background: -moz-linear-gradient(white, lightgrey); /* For Firefox 3.6 to 15 */
        background: linear-gradient(white, lightgrey); /* Standard syntax */
        border-bottom: 1px solid grey;
    }

    .ag-file-browser .ag-header-cell {
        border-right: 1px solid grey;
    }

    .ag-file-browser .ag-header-cell-label {
        padding: 4px;
    }

    .ag-file-browser .ag-row:hover {
        background-color: aliceblue;
    }

    .ag-file-browser .ag-body {
        background-color: #ffffff;
    }

    .ag-file-browser .ag-body-viewport {
        background-color: #ffffff;
    }

</style>

<script src="../bower_components/ag-grid/dist/ag-grid.js"></script>
<script src="../bower_components/xdate/src/xdate.js"></script>
<script src="../bower_components/filesize/lib/filesize.min.js"></script>


<dom-module id="file-browser">
    <template>
        <h1>File browser</h1>
        <div style="height: 500px;">
            <ag-grid id="grid" class="ag-file-browser"></ag-grid>
        </div>
    </template>
</dom-module>

<script>
    // fileTree must be the root object of the file tree
    function gridDataFromFileTree(fileTree) {
        var result = fileTree ? fileTree.children.map(gridDataFromNode) : [];
        result = result.map(function(r) {if (r.group) r.expanded = true; return r;});
//        console.log('gridDataFromFileTree', result);
//        console.log('result data', JSON.stringify(result));
        return result;
    }

    function gridDataFromNode(node) {
        if (node.children && node.children.length) {
            return {
                group: true,
//                expanded: true,
                data: {
                    name: node.name,
                    path: node.path,
                    size: '',
                    type: 'Folder',
                    dateModified: node.dateModified
                },
                children: node.children.map(gridDataFromNode)
            }
        } else {
            return {
                group: false,
                data: {
                    name: node.name,
                    path: node.path,
                    size: node.size,
                    type: node.type,
                    dateModified: node.dateModified
                }
            }
        }
    }


    Polymer({
        is: 'file-browser',

        properties: {
            fileTree: {
                type: Array,
                value: function () {
                    return {children: []};
                },
                observer: '_fileTreeChanged'
            },
            bucketName: String,
            editUrlBase: String
        },

        _fileTreeChanged: function (fileTree) {
            if (this.$.grid.api) {
                this.$.grid.api.setRowData(gridDataFromFileTree(fileTree));
            }
        },

        ready: function () {
            var self = this;
            function viewUrl(path)  {
                return "http://" + self.bucketName + ".s3.amazonaws.com/" + path;
            }

            function editUrl(path)  {
                return self.editUrlBase + "?fileUrl=" + viewUrl(path);
            }

            function viewLink(path, name) {
                return '<a href="' + viewUrl(path) + '" target="' + name + '">' + name + '</a>'
            }

            function editLink(path, name) {
                return '<a href="' + editUrl(path) + '" target="' + 'edit_' + name + '">' +
                        '<i class="fa fa-pencil-square-o" style="padding-left: 11px; font-size: 1.3em;"></i>' + '</a>'
            }

            function nameCellRenderer(params) {
                var image;
                if (params.node.group) {
                    image = params.node.level === 0 ? 'disk' : 'folder';
                } else {
                    image = 'file';
                }

                //TODO use class with background image so path relative to CSS
                var imageFullUrl = '../../bower_components/ag-grid/dist/' + image + '.png';
                var cellContent = params.node.group ? params.data.name : viewLink(params.data.path, params.data.name);
                return '<img src="' + imageFullUrl + '" style="padding-left: 4px;" /> ' + cellContent;
            }

            function editCellRenderer(params) {
                return params.node.group ? '' : editLink(params.data.path, params.data.name);
            }

           function sizeCellRenderer(params) {
                return params.node.group ? '' : filesize(params.data.size);
            }

            function dateCellRenderer(params) {
                var date = params.data.dateModified;
                return date ? new XDate(params.data.dateModified).toString("dd MMM yyyy hh:mm") : '';
            }

            function sizeCellStyle() {
                return {'text-align': 'right'};
            }

            var columnDefs = [
                {
                    headerName: "Name", field: "name", width: 250,
                    cellRenderer: {
                        renderer: 'group',
                        innerRenderer: nameCellRenderer
                    }
                },
                { headerName: "Edit", width: 50, cellRenderer: editCellRenderer},
                {headerName: "Size", field: "size", width: 100, cellStyle: sizeCellStyle, cellRenderer: sizeCellRenderer},
                {headerName: "Type", field: "type", width: 150},
                {headerName: "Date Modified", field: "dateModified", width: 175, cellRenderer: dateCellRenderer}
            ];

            var gridOptions = {
                columnDefs: columnDefs,
                rowData: gridDataFromFileTree(this.fileTree),
                rowSelection: 'multiple',
                rowsAlreadyGrouped: true,
                enableColResize: true,
                enableSorting: true,
                rowHeight: 20,
                icons: {
                    groupExpanded: '<i class="fa fa-minus-square-o"/>',
                    groupContracted: '<i class="fa fa-plus-square-o"/>'
                },
                overlayNoRowsTemplate: '<span style="padding: 10px; border: 2px solid #444;">Loading file list...</span>'
//                onRowClicked: rowClicked
            };

            this.$.grid.setGridOptions(gridOptions);

        }


    });

</script>
