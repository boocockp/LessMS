<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="../bower_components/aws-sdk/dist/aws-sdk.js"></script>
<script src="../bower_components/lodash/lodash.js"></script>

<dom-module id="s3-file-tree">
    <template>
        <style>
            p {
                display: none;
                color: #aaaaaa;
            }
        </style>

        <p>{{identityPoolId}}</p>
    </template>
</dom-module>

<script>
    function fileTreeFromS3(s3Items, folder) {
        return {
            name: "/",
            children: extractItemsInFolder(s3Items, folder)
        }
    }

    function typeFromExtension(name) {
        if (!_.includes(name, '.')) {
            return "";
        } else {
            var ext = _.last(name.split('.'));
            return _.capitalize(ext);
        }

    }

    function extractItemsInFolder(items, folder) {
        var prefix = folder + '/';
        var nameStart = prefix.length;
        var itemsWithPrefix = items.filter( function(it) { return it.Key.indexOf(prefix) === 0;});
        var leafItems = itemsWithPrefix.filter( function(it) { return it.Key.indexOf('/', nameStart) === -1;});
        var subFolderItems = itemsWithPrefix.filter( function(it) { return it.Key.indexOf('/', nameStart) !== -1;});
        var subFolderNamesWithDups = subFolderItems.map( function(it) {
            var folderNameEnd = it.Key.indexOf('/', nameStart);
            return it.Key.substring(nameStart, folderNameEnd);
        });
        var subFolderNames = _.uniq(subFolderNamesWithDups, true);
        var leafResults = leafItems.map(function(it) {
            var name = it.Key.substring(nameStart);
            return {
                name: name,
                path: it.Key,
                size: it.Size,
                type: typeFromExtension(name),
                dateModified: it.LastModified}
            });

        var subFolderResults = subFolderNames.map(function(subName) {
            var path = prefix + subName;
            return {
                name: subName,
                path: path,
                children: extractItemsInFolder(subFolderItems, path)
            }
        });

        return _.sortBy(subFolderResults.concat(leafResults), 'name');

    }

    Polymer({
        is: 's3-file-tree',

        properties: {
            bucketName: {
                type: String
            },
            filesUploaded: {
                type: Array,
                value: function() { return [];}
            },
            identityPoolId: String,
            googleIdToken: String,
            fileTree: {
                type: Object,
                readOnly: true,
                notify: true
            }
        },
        observers: [
            '_updateFileTree(googleIdToken, filesUploaded)'
        ],

        _updateFileTree: function (googleIdToken) {
            console.log("_updateFileTree", "googleIdToken", googleIdToken);
            if (!googleIdToken) return;

            AWS.config.region = this.identityPoolId.split(":")[0];
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: this.identityPoolId,
                Logins: {
                    'accounts.google.com': this.googleIdToken
                }
            });

            var s3bucket = new AWS.S3({ params: {Bucket: this.bucketName} });

            var cognitoidentity = new AWS.CognitoIdentity();
            var params = {
                IdentityPoolId: this.identityPoolId,
                Logins: {
                    'accounts.google.com': this.googleIdToken
                }
            };

            var self = this;
            cognitoidentity.getId(params, function(err, identity) {
                if (err) console.log('Failed to get id', err, err.stack);
                else {
                    console.log('Got id', identity);
                    var folder = identity.IdentityId;
                    s3bucket.listObjects({Prefix: folder}, function (error, data) {
                        if (error) {
                            console.log('Error listing objects', error);
                        } else {
                            console.log('listObjects', data);
                            var treeFromS3 = fileTreeFromS3(data.Contents, folder);
                            console.log('fileTree', treeFromS3);
                            self._setFileTree(treeFromS3);
                        }
                    });
                }
            });

        },


        ready: function () {
        }

    });

</script>
