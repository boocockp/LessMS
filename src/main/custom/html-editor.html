<link rel="import" href="../bower/polymer/polymer.html">

<link rel="import" href="test-box.html">

<script>
    window.CKEDITOR_BASEPATH = "bower/ckeditor/";
</script>
<script src="../bower/ckeditor/ckeditor.js"></script>

<dom-module id="html-editor">
    <style>
        #editorFrame {
            width: 100%;
            height: 500px;
        }

        #topToolbar {
            min-height: 80px;
        }
    </style>
    <template>
        <div id="topToolbar"></div>
        <iframe id="editorFrame"></iframe>
        <div id="bottomToolbar"></div>
    </template>
</dom-module>

<script>
    CKEDITOR.plugins.addExternal( 'timestamp', '../../ckePlugins/timestamp/', 'plugin.js' );
    CKEDITOR.plugins.addExternal( 'box', '../../ckePlugins/box/', 'plugin.js' );

    function createEditor(el) {
        el.setAttribute('contenteditable', 'true');
        return CKEDITOR.inline(body, {
            fullPage: true,
            allowedContent: true,
            extraPlugins: 'sharedspace,timestamp,box',
            extraAllowedContent: 'test-box',
            removePlugins: 'resize',
            sharedSpaces: {
                top: 'topToolbar',
                bottom: 'bottomToolbar'
            }
        });
    }

    function createEl(name, attrs) {
        var el = document.createElement(name);
        for (a in attrs) {
            if (attrs.hasOwnProperty(a)) {
                el.setAttribute(a, attrs[a]);
            }
        }
        return el;
    }

    function waitFor(condition, action) {
        if (condition()) {
            action()
        } else {
            setTimeout(function() { waitFor(condition, action); }, 100);
        }
    }

    function toArray(l) {
        return Array.prototype.slice.call(l, 0);
    }

    Polymer({
        is: 'html-editor',

        properties: {
            fileData: {
                type: String,
                observer: '_fileDataChanged'
            }
        },

        _fileDataChanged: function (data) {
            var comp = this;
            var iframe = this.$.editorFrame;
            this.originalHead = data.match(/<head>[\s\S]*<\/head>/)[0] || '<head></head>';

            iframe.contentWindow.document.open();
            iframe.contentWindow.document.write(data);
            iframe.contentWindow.document.close();

            function dragulaLoaded() { return iframe.contentWindow && iframe.contentWindow.dragula; }
            function initDragula() {
                var iframeBody = iframe.contentWindow.document.body;
                var containersInIframe = toArray(iframe.contentWindow.document.querySelectorAll('[data-drag-container]')).concat(iframeBody);
                iframe.contentWindow.dragula(containersInIframe);
            }

            iframe.onload = function() {
                iframe.contentWindow.document.head.appendChild(createEl('link', { rel: "stylesheet", href: "/LessMS/src/main/bower/dragula.js/dist/dragula.css"}));
                iframe.contentWindow.document.head.appendChild(createEl('script', {src: "/LessMS/src/main/bower/dragula.js/dist/dragula.patched.js"}));
                waitFor(dragulaLoaded, initDragula)
            }
        },

        ready: function () {
        },

        getFileData: function () {
            var iframe = this.$.editorFrame;
            var head = this.originalHead;
            var newHeadElements = iframe.contentWindow.document.querySelectorAll('head [data-cke-new]');
            if (newHeadElements) {
                for (var i = 0; i < newHeadElements.length; i++) {
                    var elText = newHeadElements[i].outerHTML.replace(/data-cke-new(="")?/, '');
                    head = head.replace(/<\/head>/, elText + '\n' + "</head>")
                }
            }
            var body = '<body>' + this.editor.getData() + '</body>';
            return '<html>' + head + body + '</html>';
        }
    });
</script>
