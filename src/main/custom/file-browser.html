<link rel="import" href="../bower/polymer/polymer.html">

<link href="../bower/font-awesome/css/font-awesome.css" rel="stylesheet">
<link href="../bower/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="../bower/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet">
<link href="../bower/ag-grid/dist/ag-grid.css" rel="stylesheet">
<link href="../bower/ag-grid/dist/theme-fresh.css" rel="stylesheet">

<script src="../bower/lodash/lodash.js"></script>
<script src="../bower/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="../bower/clipboard/dist/clipboard.js"></script>
<style>

    .ag-file-browser .ag-root {
        border: 1px solid grey;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    .ag-file-browser .ag-cell {
        padding-left: 8px;
        padding-right: 8px;
    }

    .ag-file-browser .ag-header-container {
        background: -webkit-linear-gradient(white, lightgrey); /* For Safari 5.1 to 6.0 */
        background: -o-linear-gradient(white, lightgrey); /* For Opera 11.1 to 12.0 */
        background: -moz-linear-gradient(white, lightgrey); /* For Firefox 3.6 to 15 */
        background: linear-gradient(white, lightgrey); /* Standard syntax */
        border-bottom: 1px solid grey;
    }

    .ag-file-browser .ag-header-cell {
        border-right: 1px solid grey;
    }

    .ag-file-browser .ag-header-cell-label {
        padding: 4px;
    }

    .ag-file-browser .ag-row:hover {
        background-color: aliceblue;
    }

    .ag-file-browser .ag-body {
        background-color: #ffffff;
    }

    .ag-file-browser .ag-body-viewport {
        background-color: #ffffff;
    }

    .ag-file-browser .ag-action {
        display: inline;
        margin-left: 10px;
        font-size: 1.1em;
        text-decoration: none;
    }

    .ag-file-browser .ag-action a {
        text-decoration: none;
        cursor: pointer;
    }

    .ag-file-browser .fb-name {
        cursor: move;
    }

    .ag-file-browser .fb-name.dragging {
        opacity: 0.4;
    }

    .ag-file-browser .fb-name.fb-folder.over {
        border: 1px solid green;
    }

    .ag-file-browser .dropdown-header {
        font-size: 14px;
    }

    .ag-file-browser .dropdown-menu .divider {
        margin: 4px 0
    }

    .ag-file-browser .new-folder-name {
        margin: 5px;
        width: 20em;
    }

    .ag-file-browser .dropdown-input {
        padding: 3px 20px;
    }

</style>

<script src="../bower/ag-grid/dist/ag-grid.js"></script>
<script src="../bower/xdate/src/xdate.js"></script>
<script src="../bower/filesize/lib/filesize.min.js"></script>


<dom-module id="file-browser">
    <template>
        <h1>Your files</h1>
        <div style="height: 500px;">
            <ag-grid id="grid" class="ag-file-browser"></ag-grid>
        </div>
        <input id="fileInput" type="file" multiple style="display:none">
    </template>
</dom-module>

<script>

    function createElement(html) {
        var el = document.createElement('div');
        el.innerHTML = html;
        return el.childNodes[0];
    }

    // fileTree must be the root object of the file tree
    function gridDataFromFileTree(fileTreeRoot, previouslyExpandedPaths) {
        if (!fileTreeRoot) return [];

        var pathsToExpand = previouslyExpandedPaths.concat(fileTreeRoot.path);

        function isExpanded(path) { return _.includes(pathsToExpand, path); }

        function gridDataFromNode(node) {
            if (node.children) {
                return {
                    group: true,
                    expanded: isExpanded(node.path),
                    data: {
                        name: node.name,
                        path: node.path,
                        size: '',
                        type: 'Folder',
                        dateModified: node.dateModified
                    },
                    children: node.children.map(gridDataFromNode)
                }
            } else {
                return {
                    group: false,
                    data: {
                        name: node.name,
                        path: node.path,
                        size: node.size,
                        type: node.type,
                        dateModified: node.dateModified
                    }
                }
            }
        }

        var result = [gridDataFromNode(fileTreeRoot)];
//        console.log('gridDataFromFileTree', result);
//        console.log('result data', JSON.stringify(result));
        return result;
    }


    function findExpandedPaths(gridApi) {
        var result = [];
        gridApi.forEachNode(function(node) {
            if (node.expanded) {
                result.push(node.data.path);
            }
        });

        return result;
    }


    Polymer({
        is: 'file-browser',

        properties: {
            fileTree: {
                type: Object,
                observer: '_fileTreeChanged'
            },
            bucketName: String,
            editUrlBase: String,
            newUrlBase: String,
            filesToUpload: {
                type: Object,
                readOnly: true,
                notify: true
            },
            filePathToMove: {
                type: String,
                readOnly: true,
                notify: true
            },
            destinationFilePath:  {
                type: String,
                readOnly: true,
                notify: true
            },
            folderToCreate: {
                type: String,
                readOnly: true,
                notify: true
            }

        },

        _fileTreeChanged: function (fileTree) {
            if (this.$.grid.api) {
                var expandedPaths = findExpandedPaths(this.$.grid.api);
                this.$.grid.api.setRowData(gridDataFromFileTree(fileTree, expandedPaths));
            }
        },

        listeners: {
            click: 'onClick',
            submit: 'onSubmit',
            dragstart: 'onDragStart',
            dragenter: 'onDragEnter',
            dragleave: 'onDragLeave',
            dragover: 'onDragOver',
            drop: 'onDrop',
            dragend: 'onDragend'
        },

        onClick: function(e) {
            var button = e.target;
            var uploadPath = button.getAttribute('data-upload');
            if (uploadPath) {
                this._selectFilesToUpload(uploadPath);
            }

            var newType = button.getAttribute('data-newtype');
            if (newType) {
                var newPath = button.parentElement.parentElement.parentElement.getAttribute('data-newpath');
                this._editNewFile(newType, newPath);
            }
        },

        onSubmit: function(e) {
            var form = e.target;

            var newFolderPath = form.getAttribute('data-newfolder');
            if (newFolderPath) {
                e.preventDefault();
                var newFolderName = form.querySelector(".new-folder-name").value;
                this._newFolder(newFolderPath, newFolderName);
            }
        },

        onDragStart: function(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.path);
        },

        onDragEnter: function(e) {
            if (e.target.classList.contains("fb-folder")) {
                e.target.classList.add('over');
            }
        },

        onDragLeave: function(e) {
            e.target.classList.remove('over');
        },

        onDragOver: function(e) {
            if (e.target.classList.contains("fb-folder")) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }
        },

        onDrop: function(e) {
            if (e.target.classList.contains("fb-folder")) {
                var toPath = e.target.path;
                var sourcePath = e.dataTransfer.getData('text/plain');
                this._setFilePathToMove(sourcePath);
                this._setDestinationFilePath(toPath);
            }
        },

        onDragend: function(e) {
            e.stopPropagation(); // stops the browser from redirecting.
            var folderEls = this.querySelectorAll(".fb-name");
            [].forEach.call(folderEls, function (el) {
                el.classList.remove('dragging');
                el.classList.remove('over');
            })
        },

        _selectFilesToUpload: function(path) {
            var comp = this;

            this.$.fileInput.onchange = function() {
                console.log('Files selected', this.files);
                comp._setFilesToUpload({path: path, files: this.files} );
            };
            this.$.fileInput.click();
        },

        _editNewFile: function(newType, newPath) {
            console.log('_editNewFile', newType, newPath);
            var editNewUrl = this.newUrlBase + "?fileBasePath=" + newPath + "&contentType=" + newType;
            window.open(editNewUrl, 'newFile')
        },

        _newFolder: function(parentPath, folderName) {
            console.log('_newFolder', parentPath, folderName);
            this._setFolderToCreate(parentPath + '/' + folderName);
        },

        ready: function () {
            var self = this;
            function displayPath(path) {
                var UUID_REGEX = '[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}';
                var REGION_REGEX = '[a-z]{2}-[a-z]+-\\d';
                var ID_REGEX = REGION_REGEX + ':' + UUID_REGEX;
                var pathNoId = path.replace(new RegExp(ID_REGEX), '');
                var parentFolder = pathNoId.split('/').pop();
                return parentFolder ? parentFolder : 'Your files';
            }

            function viewUrl(path)  {
                return "http://" + self.bucketName + ".s3.amazonaws.com/" + path;
            }

            function editUrl(path)  {
                return self.editUrlBase + "?fileUrl=" + viewUrl(path);
            }

            function viewLink(path, name) {
                return '<a href="' + viewUrl(path) + '" target="' + name + '" draggable="false">' + name + '</a>'
            }

            function copyButton(path, name) {
                return '<a href="#" data-clipboard-text="' + viewUrl(path) + '" class="ag-action" title="Copy link to clipboard">' +
                        '<i class="fa fa-clipboard"></i>' + '</a>'
            }

            function editLink(path, name) {
                return '<a href="' + editUrl(path) + '" target="' + 'edit_' + name + '" class="ag-action" title="Edit">' +
                        '<i class="fa fa-pencil-square-o"></i>' + '</a>'
            }

            function uploadLink(path) {
                return '<a href="#" class="ag-action fa fa-upload" title="Upload" data-upload="' + path + '"></a>';
            }

            function newFolderDropdown(path) {
                var html =
                        '<div class="ag-action dropdown">' +
                        '<a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" title="New folder">' +
                        '        <span class="fa fa-folder-o">' +
                        '        <span class="caret"></span>' +
                        '</a>' +
                        '<ul class="dropdown-menu">' +
                        '  <li class="dropdown-header">New folder in <strong>' + displayPath(path) + '</strong></li>' +
                        '  <li role="separator" class="divider"></li>' +
                        '  <li class="dropdown-input">' +
                        '    <form data-newfolder="' + path + '">' +
                        '      <span>Name</span><input class="new-folder-name">' +
                        '      <button type="submit" class="create-folder btn btn-sm btn-primary">Create folder</button>' +
                        '    </form>' +
                        '  </li>' +
                        '</ul>' +
                        '</div>';
                return html;
            }

            function newFileMenu(path) {
                var html =
                        '<div class="ag-action dropdown" data-newpath="' + path + '">' +
                        '<a class="dropdown-toggle"id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" title="New file">' +
                        '        <span class="fa fa-file-o">' +
                        '        <span class="caret"></span>' +
                        '</a>' +
                        '<ul class="dropdown-menu" aria-labelledby="dropdownMenu1">' +
                        '  <li class="dropdown-header">New file</li>' +
                        '  <li role="separator" class="divider"></li>' +
                        '  <li><a href="#" data-newtype="text/html">HTML page</a></li>' +
                        '  <li><a href="#" data-newtype="text/css">CSS file</a></li>' +
                        '  <li><a href="#" data-newtype="text/js">JavaScript file</a></li>' +
                        '  <li><a href="#" data-newtype="application/json">JSON file</a></li>' +
                        '  <li><a href="#" data-newtype="text/plain">Text file</a></li>' +
                        '</ul>' +
                        '</div>';
                return html;
            }

            function nameCellRenderer(params) {
                var image;
                if (params.node.group) {
                    image = params.node.level === 0 ? 'disk' : 'folder';
                } else {
                    image = 'file';
                }

                //TODO use class with background image so path relative to CSS
                var imageFullUrl = 'custom/images/' + image + '.png';
                var name = params.node.level === 0 ? 'Your files' : params.data.name;
                var cellContent = params.node.group ? name : viewLink(params.data.path, name);
                var classList = params.node.group ? "fb-name fb-folder" : "fb-name fb-file";
                var cell = createElement('<span draggable="true" class="' + classList + '"><img src="' + imageFullUrl + '" style="padding-left: 4px;" draggable="false"/> ' + cellContent + '</span>');
                cell.path = params.data.path;
                return cell;
            }

            function actionsCellRenderer(params) {
                var path = params.data.path;
                return params.node.group ? uploadLink(path) + newFileMenu(path) + newFolderDropdown(path) : copyButton(path, params.data.name) + editLink(path, params.data.name);
            }

           function sizeCellRenderer(params) {
                return params.node.group ? '' : filesize(params.data.size, {round: 0});
            }

            function dateCellRenderer(params) {
                var date = params.data.dateModified;
                return date ? new XDate(params.data.dateModified).toString("dd MMM yyyy HH:mm") : '';
            }

            function sizeCellStyle() {
                return {'text-align': 'right'};
            }

            function actionsCellStyle() {
                return {'overflow': 'visible'};
            }

            var columnDefs = [
                {
                    headerName: "Name", field: "name", width: 250,
                    cellRenderer: {
                        renderer: 'group',
                        innerRenderer: nameCellRenderer
                    }
                },
                { headerName: "Actions", width: 120, cellStyle: actionsCellStyle, cellRenderer: actionsCellRenderer},
                {headerName: "Size", field: "size", width: 100, cellStyle: sizeCellStyle, cellRenderer: sizeCellRenderer},
                {headerName: "Type", field: "type", width: 150},
                {headerName: "Date Modified", field: "dateModified", width: 175, cellRenderer: dateCellRenderer}
            ];

            var gridOptions = {
                columnDefs: columnDefs,
                rowData: gridDataFromFileTree(this.fileTree, []),
                rowSelection: 'multiple',
                rowsAlreadyGrouped: true,
                enableColResize: true,
                enableSorting: true,
                suppressCellSelection: true,
                rowHeight: 20,
                icons: {
                    groupExpanded: '<i class="fa fa-minus-square-o"/>',
                    groupContracted: '<i class="fa fa-plus-square-o"/>'
                },
                overlayNoRowsTemplate: '<span style="padding: 10px; border: 2px solid #444;">Loading file list...</span>'
//                onRowClicked: rowClicked
            };

            this.$.grid.setGridOptions(gridOptions);

            new Clipboard('[data-clipboard-text]');

        }


    });

</script>
